<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MHE Management Home - QR/Driver PIN Flow</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
/* --- Body & Background Animation --- */
body { 
  font-family:'Inter',sans-serif; 
  background: linear-gradient(120deg,#111827,#1f2937,#111827);
  background-size: 400% 400%;
  animation: gradientBG 15s ease infinite;
  color:#f3f4f6; padding:20px; 
}
@keyframes gradientBG {
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}

/* --- Headings --- */
h2 { 
  text-align:center; color:#3b82f6; margin-bottom:30px; 
  animation: fadeInUp 0.8s ease forwards;
}

/* --- Smooth Card Transitions --- */
.card {
  background: rgba(255,255,255,0.05); 
  border-radius: 20px; 
  padding:20px; 
  margin:20px auto; 
  max-width:900px; 
  display:none;
  opacity:0;
  transform: translateY(20px);
  transition: all 0.5s ease-in-out;
}
.card.show { opacity:1; transform: translateY(0); }

/* --- Buttons --- */
button, button.action, button.secondary {
  transition: all 0.3s ease-in-out;
  border:none; cursor:pointer;
}
button:hover, button.action:hover, button.secondary:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 20px rgba(59,130,246,0.4);
}

/* --- MHE Cards --- */
.mhe-card {
  background:rgba(255,255,255,0.03); 
  border-radius:10px; 
  padding:12px; 
  text-align:center; 
  cursor:pointer;
  transition: all 0.3s ease-in-out;
  opacity:0;
  transform: translateY(20px);
}
.mhe-card.free:hover { 
  transform: translateY(-5px) scale(1.05); 
  background: rgba(34,197,94,0.15); 
}
.mhe-card.occupied:hover { 
  transform: translateY(-2px);
}
.mhe-card.show { opacity:1; transform: translateY(0); }

/* --- Dashboard Numbers Animation --- */
.dashboard-number {
  transition: all 0.5s ease;
  transform: scale(1);
}
.dashboard-number.update {
  transform: scale(1.2);
  color: #facc15;
}

/* --- FadeIn Animation --- */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px);}
  to { opacity: 1; transform: translateY(0);}
}

/* --- Smooth Table & Filters --- */
.filters input, .filters select, .filters button {
  transition: all 0.3s ease-in-out;
}
.filters input:focus, .filters select:focus, .filters button:focus {
  outline:none; box-shadow:0 0 10px #3b82f6;
}

/* --- Hide/Show Animation --- */
.hide { display:none !important; opacity:0; transition: opacity 0.5s ease; }
.showSection { display:block !important; opacity:1; transition: opacity 0.5s ease; }

/* --- Search Input Animation --- */
.searchable { transition: all 0.3s ease-in-out; }
.searchable:focus { transform: scale(1.02); box-shadow:0 0 8px #3b82f6; }

/* --- Card Hover Pop --- */
.card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }

/* --- Table Hover --- */
table tbody tr:hover { background: rgba(59,130,246,0.1); transition: all 0.3s ease-in-out; }
</style>
</head>
<body>

<h2>MHE Management System</h2>

<div class="home-buttons" id="homeButtons">
  <button onclick="openSection('takeKeysCard')">Take Keys</button>
  <button onclick="openSection('dashboardCard')">Live Dashboard</button>
  <button onclick="openSection('historyCard')">Assignment History</button>
</div>

<!-- Take Keys -->
<div class="card" id="takeKeysCard">
  <h3>Take Keys</h3>
  <label>Driver Name / ID:
    <input type="text" id="driverSearch" class="searchable" placeholder="Search driver...">
    <select id="driverSelect"></select>
  </label>

  <label>Available MHEs (click to take):</label>
  <div id="takeMheGrid" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-top:10px;"></div>

  <div style="margin-top:12px; display:flex; gap:10px;">
    <button class="action" onclick="manualAssignFromSelect()">Assign Selected MHE</button>
  </div>
</div>

<!-- Dashboard -->
<div class="card" id="dashboardCard">
  <h3>üìä Live Dashboard</h3>
  <div style="display:flex; gap:20px; flex-wrap:wrap; margin-bottom:20px;">
    <div style="flex:1; min-width:150px; background:#1f2937; padding:15px; border-radius:12px; text-align:center;">
      <h4>Total MHE</h4><p id="totalMhe" class="dashboard-number" style="font-size:24px; font-weight:bold; color:#3b82f6;">0</p>
    </div>
    <div style="flex:1; min-width:150px; background:#1f2937; padding:15px; border-radius:12px; text-align:center;">
      <h4>Free</h4><p id="freeMhe" class="dashboard-number" style="font-size:24px; font-weight:bold; color:#22c55e;">0</p>
    </div>
    <div style="flex:1; min-width:150px; background:#1f2937; padding:15px; border-radius:12px; text-align:center;">
      <h4>Occupied</h4><p id="occupiedMhe" class="dashboard-number" style="font-size:24px; font-weight:bold; color:#ef4444;">0</p>
    </div>
  </div>
  <div id="mheGrid" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:15px;"></div>
  <h4>Active Assignments</h4>
  <ul id="activeAssignments"></ul>
</div>

<!-- History -->
<div class="card" id="historyCard">
  <h3 style="display:flex; justify-content:space-between; align-items:center;">
    MHE Assignment History
    <button id="historyToggleBtn" onclick="toggleHistory()" style="background:#6b7280; color:white; padding:4px 10px; border-radius:6px; border:none; cursor:pointer;">Hide</button>
  </h3>
  <div id="historyContent" style="display:none;">
    <div class="filters">
      <input type="date" id="reportDate">
      <input type="text" id="driverFilter" placeholder="Filter by driver">
      <select id="mheFilter"><option value="">All MHEs</option></select>
      <button onclick="loadReport()">Apply Filters</button>
      <button onclick="exportToExcel()">Export Excel</button>
    </div>
    <table id="reportTable">
      <thead>
        <tr>
          <th>MHE</th><th>Driver</th><th>Action</th><th>Timestamp</th><th>Status</th><th>Shift</th><th>Duration</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="flex-row">
      <div class="chart-container"><canvas id="usageChart"></canvas></div>
      <div class="chart-container"><canvas id="timelineChart"></canvas></div>
    </div>
  </div>
</div>

<script>
function openSection(id){
  document.querySelectorAll(".card").forEach(c=>{ 
    c.classList.remove("show"); 
    c.style.display="none";
  });
  const card=document.getElementById(id);
  card.style.display="block";
  setTimeout(()=>card.classList.add("show"),10);
}
function toggleHistory() {
  const content = document.getElementById("historyContent");
  const btn = document.getElementById("historyToggleBtn");
  if (content.style.display === "none") { content.style.display="block"; btn.textContent="Hide"; }
  else { content.style.display="none"; btn.textContent="Show"; }
}
</script>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getFirestore, collection, doc, getDocs, getDoc, setDoc, addDoc, updateDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBx_26h3CD_fRCILcmWLuDUc8v8pzH8Sxo",
  authDomain: "mhe-checksheet.firebaseapp.com",
  projectId: "mhe-checksheet",
  storageBucket: "mhe-checksheet.appspot.com",
  messagingSenderId: "413824836416",
  appId: "1:413824836416:web:63faa90294e161363510a5",
  measurementId: "G-ZQ77KHXXVB"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const SUPERVISOR_PIN = "1234";
let currentUser = null;
// Allowed location coordinates (example: latitude & longitude of your site)
// Allowed location coordinates
const ALLOWED_LAT = 28.389790825187863;
const ALLOWED_LNG = 77.31411387583914;
const ALLOWED_RADIUS_M = 500; // allowed radius in meters

// Haversine formula to calculate distance between two coords
function getDistance(lat1, lon1, lat2, lon2){
  const R = 6371e3; // metres
  const œÜ1 = lat1 * Math.PI/180;
  const œÜ2 = lat2 * Math.PI/180;
  const ŒîœÜ = (lat2-lat1) * Math.PI/180;
  const ŒîŒª = (lon2-lon1) * Math.PI/180;
  const a = Math.sin(ŒîœÜ/2)*Math.sin(ŒîœÜ/2) +
            Math.cos(œÜ1)*Math.cos(œÜ2)*
            Math.sin(ŒîŒª/2)*Math.sin(ŒîŒª/2);
  const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

// Check location before allowing page to load
async function checkLocation(){
  if(!navigator.geolocation){
    alert("Geolocation not supported. Cannot access page.");
    document.body.innerHTML="<h2 style='color:red;text-align:center'>‚ùå Location access required</h2>";
    throw new Error("No geolocation support");
  }

  return new Promise((resolve,reject)=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      const dist = getDistance(ALLOWED_LAT, ALLOWED_LNG, pos.coords.latitude, pos.coords.longitude);
      if(dist <= ALLOWED_RADIUS_M) resolve(true);
      else {
        document.body.innerHTML="<h2 style='color:red;text-align:center'>‚ùå You are not at the allowed location</h2>";
        reject("Outside allowed location");
      }
    }, err=>{
      document.body.innerHTML="<h2 style='color:red;text-align:center'>‚ùå Location permission denied</h2>";
      reject(err);
    });
  });
}


window.onload = async () => {
  try {
    await checkLocation(); // check location first
    checkAccess();          // then proceed with PIN
  } catch(e) {
    console.warn("Access denied:", e);
  }
};


async function checkAccess(){
  const pin = prompt("Enter PIN:");
  if(!pin){ document.body.innerHTML="<h2 style='color:red;text-align:center'>‚ùå No PIN entered</h2>"; return; }
  if(pin===SUPERVISOR_PIN){
    await loadDrivers(); await loadReport(); await loadDashboard();
    document.getElementById('homeButtons').style.display='flex';
    openSection('dashboardCard'); return;
  }
  const q=query(collection(db,'drivers'),where('pin','==',pin));
  const snap=await getDocs(q);
  if(snap.empty){ document.body.innerHTML="<h2 style='color:red;text-align:center'>‚ùå Invalid PIN</h2>"; return; }
  const docSnap=snap.docs[0]; currentUser={...(docSnap.data()),id:docSnap.id};
  document.getElementById('homeButtons').style.display='none';
  await loadDrivers(); selectDriverInDropdown(currentUser.name||currentUser.id);
  openSection('takeKeysCard'); await loadDashboard(); renderTakeKeysGrid();
  alert(`Welcome ${currentUser.name||currentUser.id}`);
}

async function loadDrivers(){
  const driverSelect=document.getElementById("driverSelect");
  driverSelect.innerHTML='<option value="">-- Select Driver --</option>';
  const snap=await getDocs(collection(db,"drivers"));
  snap.forEach(d=>{ const data=d.data(); const o=document.createElement("option"); o.value=data.name||data.id; o.textContent=`${data.name||data.id}`; driverSelect.appendChild(o); });
  if(currentUser){ driverSelect.value=currentUser.name||currentUser.id; driverSelect.disabled=true; document.getElementById('driverSearch').classList.add('hide'); }
  else{ driverSelect.disabled=false; document.getElementById('driverSearch').classList.remove('hide'); }
}

function selectDriverInDropdown(name){
  const sel=document.getElementById('driverSelect');
  for(let i=0;i<sel.options.length;i++){ if(sel.options[i].textContent.toLowerCase().includes(name.toLowerCase())){ sel.selectedIndex=i; break; } }
  sel.disabled=true; document.getElementById('driverSearch').classList.add('hide');
}

async function assignKeyToDriver(driver,mhe,skipPin=false){
  if(!driver||!mhe){ alert("Driver & MHE required"); return; }
  const activeSnap=await getDocs(query(collection(db,"assignments"),where("driver","==",driver),where("active","==",true)));
  if(!skipPin && !currentUser?.pin){ const enteredPin=prompt(`Enter PIN for ${driver}`); if(!enteredPin){ alert("PIN required"); return; } }
  if(!activeSnap.empty){ alert(`‚ùå ${driver} already has an active MHE! Return key first.`); return; }

  const mheRef=doc(db,"assignments",mhe); const mheSnap=await getDoc(mheRef);
  if(mheSnap.exists() && mheSnap.data().active){ alert(`‚ùå ${mhe} already in use`); return; }

  await setDoc(mheRef,{driver,mhe,assignedAt:new Date().toISOString(),active:true});
  await addDoc(collection(db,"history"),{driver,mhe,action:"assigned",timestamp:new Date().toISOString()});
  alert(`‚úÖ ${driver} assigned to ${mhe}`);
  await loadReport(); await loadDashboard(); renderTakeKeysGrid();
}

function onMheCardClick(mhe,isFree){
  if(!isFree) return;
  const driver=currentUser?currentUser.name||currentUser.id:document.getElementById('driverSelect').value;
  if(!driver){ alert('Select driver'); return; }
  if(confirm(`Confirm take ${mhe}?`)){ assignKeyToDriver(driver,mhe,currentUser?.pin?true:false); }
}

function manualAssignFromSelect(){
  const driver=document.getElementById('driverSelect').value;
  const mhe=prompt("Enter MHE (e.g. MHE3)"); if(!mhe) return;
  assignKeyToDriver(driver,mhe,currentUser?.pin?true:false);
}

async function returnKey(mhe){
  if(!mhe){ alert("Select MHE"); return; }
  const ref=doc(db,"assignments",mhe); 
  const snap=await getDoc(ref);
  if(!snap.exists() || !snap.data().active){ alert(`${mhe} not active`); return; }

  const assignedDriver = snap.data().driver;
  if(currentUser && assignedDriver !== (currentUser.name || currentUser.id)){
    alert(`‚ùå You can only return MHE assigned to you`);
    return;
  }

  await updateDoc(ref,{active:false,returnedAt:new Date().toISOString()});
  await addDoc(collection(db,"history"),{driver:assignedDriver,mhe,action:"returned",timestamp:new Date().toISOString()});
  alert(`‚úÖ ${mhe} returned`);
  await loadReport(); 
  await loadDashboard(); 
  renderTakeKeysGrid();
}

async function loadDashboard(){
  const snap=await getDocs(collection(db,"assignments"));
  const mheStatus={}; let occupied=0,active=[];
  snap.forEach(d=>{ const data=d.data(); mheStatus[data.mhe]=data.active?data.driver:null; if(data.active){occupied++; active.push(`${data.mhe}‚Üí${data.driver}`);} });
  const total=11; const free=total-occupied;

  const totalEl=document.getElementById("totalMhe");
  const freeEl=document.getElementById("freeMhe");
  const occupiedEl=document.getElementById("occupiedMhe");
  [totalEl, freeEl, occupiedEl].forEach(el=>{ el.classList.add('update'); setTimeout(()=>el.classList.remove('update'),500); });

  totalEl.textContent=total;
  freeEl.textContent=free;
  occupiedEl.textContent=occupied;
  document.getElementById("activeAssignments").innerHTML=active.length?active.map(a=>`<li>${a}</li>`).join(''):'<li>None</li>';

  const grid=document.getElementById("mheGrid"); grid.innerHTML='';
  for(let i=1;i<=total;i++){
    const name=`MHE${i}`;
    const driver=mheStatus[name];
    const div=document.createElement("div");
    div.className='mhe-card '+(driver?'occupied':'free');
    div.innerHTML=`<h4>${name}</h4><p>${driver?driver:'Free'}</p>`;
    grid.appendChild(div);
    setTimeout(()=>div.classList.add("show"),50*i); // stagger fade-in
  }
  renderTakeKeysGrid(mheStatus);
}

async function loadReport(){
  const tbody=document.querySelector("#reportTable tbody"); tbody.innerHTML='';
  const dateFilter=document.getElementById("reportDate").value;
  const driverFilter=document.getElementById("driverFilter").value.toLowerCase();
  const mheFilter=document.getElementById("mheFilter").value;

  const snap=await getDocs(query(collection(db,"history"),orderBy("timestamp","asc")));
  const usage={}, timeline={};
  snap.forEach(d=>{ const data=d.data(); const dt=data.timestamp.split("T")[0]; if((dateFilter&&dt!==dateFilter)||(driverFilter&&!data.driver.toLowerCase().includes(driverFilter))||(mheFilter&&data.mhe!==mheFilter)) return;
  const shift=new Date(data.timestamp).getHours()<15?"Morning":"Night";
  let duration=""; if(data.action==="returned"&&data.returnedAt){ duration=Math.round((new Date(data.returnedAt)-new Date(data.assignedAt))/60000); }
  const status=data.action==="assigned"?"Active":"Returned"; const tr=document.createElement("tr");
  tr.innerHTML=`<td>${data.mhe}</td><td>${data.driver}</td><td>${data.action}</td><td>${new Date(data.timestamp).toLocaleString()}</td><td>${status
}</td><td>${shift}</td><td>${duration||"-"}</td>`; 
  tbody.appendChild(tr); 
  usage[data.mhe]=(usage[data.mhe]||0)+1; 
  const h=new Date(data.timestamp).getHours(); 
  timeline[h]=(timeline[h]||0)+1; 
  });
  drawCharts(usage,timeline);
}

function drawCharts(usage,timeline){
  try{ 
    new Chart(document.getElementById("usageChart"),{
      type:"bar",
      data:{
        labels:Object.keys(usage),
        datasets:[{label:"MHE Usage Count",data:Object.values(usage), backgroundColor:'#3b82f6'}]
      },
      options:{responsive:true, plugins:{legend:{display:true}}, animation:{duration:800}}
    }); 

    new Chart(document.getElementById("timelineChart"),{
      type:"line",
      data:{
        labels:Object.keys(timeline),
        datasets:[{label:"Usage by Hour",data:Object.values(timeline), borderColor:'#22c55e', fill:false, tension:0.3}]
      },
      options:{responsive:true, plugins:{legend:{display:true}}, animation:{duration:800}}
    });
  }catch(e){console.warn(e);}
}

async function exportToExcel(){
  const snap=await getDocs(query(collection(db,"history"),orderBy("timestamp","asc")));
  const grouped={},pending={};
  snap.forEach(docSnap=>{ 
    const data=docSnap.data(); 
    const key=`${data.driver}_${data.mhe}`; 
    const assignTime=new Date(data.timestamp);
    if(data.action==="assigned"){ 
      pending[key]={Date:assignTime.toLocaleDateString(),Driver:data.driver,"Assign Time":assignTime.toLocaleString(),"Return Time":"","Duration":"-"};}
    else if(data.action==="returned"&&pending[key]){ 
      const a=pending[key]; 
      const diffMs=new Date(data.timestamp)-new Date(a["Assign Time"]); 
      const mins=Math.floor(diffMs/60000); 
      const h=Math.floor(mins/60); 
      const m=mins%60; 
      a["Return Time"]=new Date(data.timestamp).toLocaleString(); 
      a["Duration"]=`${h}h ${m}m`; 
      if(!grouped[data.mhe]) grouped[data.mhe]=[]; 
      grouped[data.mhe].push(a); 
      delete pending[key]; 
    }
  });
  Object.values(pending).forEach(v=>{ if(!grouped[v.Driver]) grouped[v.Driver]=[]; grouped[v.Driver].push(v); });
  const wb=XLSX.utils.book_new(); 
  Object.keys(grouped).forEach(mhe=>{ 
    const ws=XLSX.utils.json_to_sheet(grouped[mhe]); 
    XLSX.utils.book_append_sheet(wb,ws,mhe); 
  });
  XLSX.writeFile(wb,`MHE_Report_${new Date().toISOString().split("T")[0]}.xlsx`);
}

document.getElementById("driverSearch").addEventListener("input",()=>{
  const filter=document.getElementById("driverSearch").value.toLowerCase(); 
  Array.from(document.getElementById("driverSelect").options)
       .forEach(o=>o.style.display=o.textContent.toLowerCase().includes(filter)?"block":"none"); 
});

async function renderTakeKeysGrid(mheStatusOverride=null){
  const snap=await getDocs(collection(db,"assignments"));
  const mheStatus={}; 
  snap.forEach(d=>{ 
    const data=d.data(); 
    mheStatus[data.mhe]=data.active?data.driver:null; 
  });
  if(mheStatusOverride) Object.assign(mheStatus,mheStatusOverride);

  const grid=document.getElementById("takeMheGrid"); 
  grid.innerHTML=''; 
  for(let i=1;i<=11;i++){ 
    const name=`MHE${i}`; 
    const driver=mheStatus[name]||null; 
    const div=document.createElement('div'); 
    div.className='mhe-card '+(driver?'occupied':'free'); 
    if(driver){
      div.innerHTML=`<h4>${name}</h4><p>${driver}</p>`;
      if(currentUser && driver === (currentUser.name || currentUser.id)){
        const retBtn=document.createElement('button');
        retBtn.textContent='Return';
        retBtn.className='action';
        retBtn.style.marginTop='8px';
        retBtn.onclick=()=>returnKey(name);
        div.appendChild(retBtn);
      }
    } else {
      div.innerHTML=`<h4>${name}</h4><p>Available</p>`;
      div.addEventListener('click',()=>onMheCardClick(name,true));
    }
    grid.appendChild(div); 
    setTimeout(()=>div.classList.add("show"),50*i); // staggered animation
  }
}
</script>
</body>
</html>

